# Lingo-Reader 本地数据结构（当前版本）

## 1. Dexie 数据库概览

- **数据库名称**：`lingo-reader`（在 `reader-html/src/services/db.ts` 中通过 Dexie 初始化）。
- **版本管理**：当前实现使用 `version(1)` 定义 `books` 与 `vocabulary` 表；未来如需变更 schema，将通过递增版本号进行迁移，此文档仅描述当前生效结构。

---

## 2. `books` 表（书架 / 电子书）

用于存储本地书架中的电子书元数据及文件内容。

| 字段名 | 类型 | 说明 |
| :----- | :--- | :--- |
| `id` | number (自增) | 主键，自增 ID，用于在应用内唯一标识一本书，并作为路由参数 `bookId` 使用 |
| `title` | string | 书名，来自解析后的电子书元数据 |
| `author` | string | 作者信息，来自解析后的电子书元数据，若缺失可为空字符串 |
| `fileName` | string | 原始文件名（含扩展名），用于从 IndexedDB 读取 `data` Blob 后重新构造 `File` 对象，并让解析管线根据扩展名选择正确的解析器 |
| `cover` | Blob | 书籍封面图片的二进制数据，在渲染时通过 `URL.createObjectURL` 等方式生成临时 URL 使用 |
| `data` | Blob | 电子书源文件的二进制数据（EPUB/MOBI/AZW3/FB2 等），仅在打开阅读器时按需加载，不在书架列表中批量读取 |
| `lastRead` | number (timestamp) | 最后阅读时间戳（例如毫秒级 Unix 时间），用于按最近阅读排序 |
| `progress` | number (0–1) | 阅读进度，取值范围为 0–1 的浮点数：0 表示未开始阅读，1 表示已读完，中间值表示已读百分比（章节内或全书整体的归一化进度，目前实现为章节内进度） |
| `currentChapterIndex` | number | 当前阅读所在章节的索引（0 起始），配合 `progress` 用于在重新打开或刷新阅读器时恢复阅读位置 |

> 删除策略：从书架中删除一本书时，物理删除 `books` 表中对应记录；`vocabulary` 表中引用该 `bookId` 的记录暂不自动清理。

---

## 3. `vocabulary` 表（生词本）

用于存储用户在阅读过程中标记的单词/短语以及对应的 AI 解释。

| 字段名 | 类型 | 说明 |
| :----- | :--- | :--- |
| `id` | string (UUID) | 主键，使用 UUID 或等价方案生成，全局唯一标识一条生词记录 |
| `word` | string | 单词或短语的原始文本，用作展示和匹配的基础字段 |
| `context` | string | 生词所在的原文例句或上下文，用于在生词卡片中回显和作为 AI 提示词的一部分 |
| `aiExplanation` | string | AI 生成的解释内容（含含义、例句、音标等），以富文本字符串形式存储 |
| `bookId` | number | 生词来源书籍的 `books.id`，用于在加载某本书时筛选对应生词 |
| `createdAt` | number (timestamp) | 生词加入时间戳（例如毫秒级 Unix 时间），用于排序或筛选最近加入的生词 |

> 匹配逻辑（与实现相关的约定）：
>
> - 英文生词匹配时不区分大小写（case-insensitive）。
> - 需要尽量覆盖常见词形变化（如过去式、进行时等），具体算法在实现层处理。
> - 匹配时使用完整单词边界，避免在 `the` 中错误匹配 `he` 等情况。

---

## 4. 其他本地存储约定（非 Dexie）

- **AI 接口配置（全部通过 `apiKeyStorage` 模块封装）**：
  - **API Key**：
    - 存储位置：`localStorage`。
    - Key 名称：`lingoReader.apiKey`。
    - 不做额外加密或混淆，使用 BYOK（用户自带 Key）模式，前端直连 OpenAI/兼容接口。
  - **Base URL**：
    - Key 名称：`lingoReader.aiBaseUrl`。
    - 默认值：`https://ark.cn-beijing.volces.com/api/v3/chat/completions`。
  - **模型名称**：
    - Key 名称：`lingoReader.aiModel`。
    - 默认值：`doubao-1.5-lite-32k-250115`。
  - **Prompt 模板**（全部为可选字符串，允许用户按需自定义）：
    - `lingoReader.aiPromptGeneral`：通用 AI Prompt（当前 UI 中已隐藏，仅保留字段供未来扩展）。
    - `lingoReader.aiPromptEnTranslate`：英文解释/分析用的 EN Prompt 模板。
    - `lingoReader.aiPromptZhExplain`：中文解释生词的 Prompt 模板，支持 `{word}`、`{context}` 占位符自动替换为选中单词及其所在上下文句子。
  - **Prompt 模式选择**：
    - `lingoReader.aiPromptMode`：当前选中的 Prompt 类型，取值 `'en' | 'zh'`，由设置页的 Tab 点击实时更新；
    - 用于指导 AI 客户端在 EN Prompt 与 ZH Prompt 之间进行切换。

---

## 5. 关键前端文件与职责

> 下列路径均相对于 `reader-html/src/`。

- **`main.ts`**
  - Vue 3 应用入口文件。
  - 创建并挂载应用实例，注册全局插件：i18n、router、pinia。
  - 指定根组件为 `App.vue`，将应用挂载到 `#app` 容器。

- **`App.vue`**
  - 应用根组件，承载全局布局与路由出口。
  - 作为后续集成书架页、阅读器页、生词相关 UI 的顶层容器。

- **`router/index.ts`**
  - 创建并导出 Vue Router 实例。
  - 使用 `createWebHashHistory('/lingo-reader/')` 作为路由历史模式和基础路径。
  - 引入并使用 `router/routes.ts` 中定义的路由表。
  - 在导航守卫中：若访问 `/book` 且 `useBookStore().existBook()` 为假，则重定向到 `home` 路由，避免在无书状态下直接进入阅读器。

- **`router/routes.ts`**
  - 定义当前应用的核心路由：
    - `'/'`，name: `home`，指向 `views/BookshelfView.vue`，作为新的默认首页（书架视图）。
    - `'/bookshelf-test'`，name: `bookshelf-test`，同样指向 `views/BookshelfView.vue`，作为开发阶段保留的测试/备用入口。
    - `'/book'`，name: `book`，指向 `pages/Book/Book.vue`，为主阅读器视图。
  - 当用户直接访问 `/book` 且当前未初始化任何书籍时，路由守卫会将其重定向到 `home`（即书架视图），避免进入无书状态的阅读器页面。

- **`pages/Home/Home.vue`**
  - 原始首页视图组件，早期用于 `/`（name: `home`）路由。
  - 在引入书架后，默认首页职责由 `views/BookshelfView.vue` 承担；`Home.vue` 可作为后续扩展的一般说明页或调试页面按需挂载到其他路由。

- **`pages/Book/Book.vue`**
  - 当前主阅读器页面，对外路由为 `/book`（name: `book`）。
  - 内部通过 `useBookStore` 访问和管理当前书籍（包括 TOC、文件名等）。
  - 负责：
    - 顶部信息栏（返回、阅读模式切换、配置面板、目录按钮等）。
    - 承载不同阅读模式组件（列式、滚动、带笔记滚动等）。
    - 处理返回行为：调用 `bookStore.reset()` 并导航回 `'/'`（首页）。
  - 未来 AI 选区分析、高亮、生词交互等功能将围绕本视图及其子阅读器组件扩展：
    - 通过 `useSelectionDebug` 与 `useSelectionMenu` 监听用户在阅读区域内的文本选中事件，并获取选中文本及其上下文句子。
    - 使用 `SelectionMenu` 浮动菜单组件在选区附近展示操作入口（例如“解释”“加入生词本”），后续将与 AI 服务和本地生词本表打通。

- **`views/BookshelfView.vue`**
  - 书架视图组件，对外测试路由为 `'/bookshelf-test'`（name: `bookshelf-test`）。
  - 负责：
    - 渲染书架标题文案 `bookshelfTitle`。
    - 提供“导入书籍”入口：使用隐藏的 `<input type="file" multiple>` 与可点击的 `<label>` 触发本地文件选择，接受 EPUB/MOBI/AZW3/FB2 等格式，并将 `change` 事件委托给 `useBookshelf.handleFilesSelected`。
    - 调用 `useBookshelf.loadBooks()` 从 Dexie 的 `books` 表异步读取当前已导入书籍的元数据（不读取 `data` Blob），并以网格形式展示：移动端双列、桌面端四列。
    - 使用 `BookCard` 作为纯 UI 子组件渲染单本书的标题和作者。
    - 监听 `BookCard` 的 `select` 事件，在用户点击卡片时调用 `useBookshelf.openBookFromId(book.id)` 从 IndexedDB 加载对应书籍到阅读管线，并通过路由跳转到 `/book` 阅读器视图。
    - 在标题区域提供“设置”按钮，点击后导航到 `SettingsView`，用于管理 AI API Key。

- **`services/` 目录**
  - 位于 `reader-html/src/services/`。
  - 用途：
    - 存放与 UI 解耦的纯 TypeScript 服务模块，例如 Dexie 本地数据库封装（db 服务）、AI 客户端封装等。
    - 这些模块不直接依赖 Vue 组件，只通过导出函数/实例供 composables 与视图调用。

- **`services/bookParser.ts`**
  - 统一的电子书解析服务：
    - 基于 monorepo 中的解析器（epub/mobi/azw3/fb2 等）和 `EBookParser` 接口，从上传文件中解析出元数据与文件信息。
    - 输出标准化结构 `ParsedBookForBookshelf`：包含书名、作者、文件名、原始 `File` 对象以及封面占位字段 `cover`。
    - 被 `useBookshelf` 调用，用于在书架导入流程中将原始文件转换为“可入库”的基础数据。

- **`services/apiKeyStorage.ts`**
  - 负责管理 AI 接口相关配置在浏览器本地的读写：
    - API Key：`getApiKey()` / `setApiKey(key)` / `clearApiKey()`，对应 `lingoReader.apiKey`。
    - Base URL：`getAiBaseUrl()` / `setAiBaseUrl(url)`，对应 `lingoReader.aiBaseUrl`，提供 Ark 默认值。
    - 模型名称：`getAiModel()` / `setAiModel(model)`，对应 `lingoReader.aiModel`，提供 Ark 默认值。
    - Prompt 模板：`getAiGeneralPrompt()`、`getAiEnTranslatePrompt()`、`getAiZhExplainPrompt()` 及对应 `set*` 方法，分别对应三个 Prompt 的 localStorage Key。
    - Prompt 模式：`getAiPromptMode()` / `setAiPromptMode(mode)`，在 `'en' | 'zh'` 之间切换当前生效的 Prompt 类型，对应 `lingoReader.aiPromptMode`。
  - 该模块为纯 TS 文件，不依赖 Vue，仅作为 Settings 视图和 AI 客户端的基础配置工具。

- **`services/aiClient.ts`**
  - 面向 OpenAI/豆包/ARK 兼容接口的前端直连 AI 客户端：
    - 不再写死 base URL 和模型，统一从 `apiKeyStorage` 读取：`getAiBaseUrl()` 与 `getAiModel()`。
    - 导出 `streamExplainSelection({ text, context }, handlers)`：
      - 从 `apiKeyStorage.getApiKey()` 读取 `lingoReader.apiKey` 作为 Bearer Token。
      - 通过 `getAiPromptMode()` 判断当前模式：`'en'` 使用 `getAiEnTranslatePrompt()`；`'zh'` 使用 `getAiZhExplainPrompt()`，并将 `{word}`、`{context}` 替换为实际选中内容，构造 user 内容。
      - 以 `stream: true` 方式请求给定 base URL，按行解析 `data:` 前缀的 SSE 流，将其中的 `delta.content` 增量通过 `handlers.onToken` 暴露给上层实现流式展示。
      - 在缺少 API Key 时通过 `handlers.onError(new Error('MISSING_API_KEY'))` 显式标记，由上层决定 UI 提示。
    - 导出 `testAiConnection()`：
      - 使用当前配置的 base URL、模型和 Prompt 发送一次非流式的短请求，仅用于“连接测试”按钮；
      - 若 HTTP 状态码非 2xx 或返回体中包含 `error` 字段，则抛出错误，供设置页展示失败原因。

- **`services/vocabularyService.ts`**
  - 生词本相关的数据库写入服务：
    - 导出 `addVocabularyItem({ word, context, aiExplanation, bookId })`，内部使用 `db.vocabulary.add` 写入 Dexie。
    - 导出 `getVocabularyByBookId(bookId)` 读取指定书籍的全部生词列表，用于章节渲染后的统一高亮。
    - 导出 `deleteVocabularyItem(id)` 按主键删除单条生词记录，供生词详情卡片中的删除操作调用。
    - 通过 `crypto.randomUUID()`（如可用）或时间戳 + 随机串生成 `id`，并填充 `createdAt` 时间戳。

- **`composables/` 目录**
  - 位于 `reader-html/src/composables/`。
  - 用途：
    - 存放基于 Vue Composition API 的状态逻辑与复用逻辑，例如书架状态管理 `useBookshelf`、阅读状态管理等。
    - 通过组合调用 `services/` 中的纯服务，实现“视图 <-> 服务”之间的解耦。

- **`composables/useBookshelf.ts`**
  - 书架相关的基础状态与交互逻辑：
    - 暴露导入流程状态 `isImporting`，用于在 UI 中显示导入中的 loading 提示。
    - 暴露 `handleFilesSelected(files)` 入口，统一处理来自书架视图的文件选择事件，是解析与写入 `books` 表的起点。
    - 在解析完成后，将解析结果写入 `books` 表：填充 `title`、`author`、`fileName`（解析得到的安全文件名）、`cover`（当前为 `null`）、`data`（原始文件 Blob）、`lastRead`（初始为 `null`）、`progress`（初始为 `0`）。
    - 暴露 `books` 列表与 `loadBooks()`：从 `books` 表读取所有记录，仅映射 `id`、`title`、`author` 到内存，用于书架网格展示，刻意避免在列表阶段读取 `data` Blob 以满足性能要求。
    - 暴露 `openBookFromId(bookId)`：
      - 从 Dexie 的 `books` 表按 `id` 读取单本书记录，使用保存的 `fileName` 与 `data` Blob 构造临时 `File` 对象。
      - 调用 `useBookStore().initBook(file)` 复用现有解析与渲染管线，将书籍加载到阅读器状态中。
      - 在成功加载后，更新该记录的 `lastRead` 为当前时间戳，用于后续按最近阅读排序.

- **`composables/useSelectionDebug.ts`**
  - 为 Phase 2 提供的调试向选区监听逻辑：
    - 监听 `mouseup` / `touchend` 事件，获取当前选中文本及其所在句子。
    - 按中英文句号/问号/感叹号切分上下文，只保留包含选中文本的句子，避免过长 context。
    - 通过 `console.info('[AI][Selection]', { text, context })` 输出调试信息，便于验证选区与上下文提取策略。

- **`composables/useSelectionMenu.ts`**
  - 负责基于当前选区管理浮动菜单的状态：
    - 暴露 `visible`、`x`、`y`、`text`、`context` 等响应式状态，用于驱动浮动菜单组件。
    - 在 `mouseup` / `touchend` 时解析当前选区位置和上下文，通过 `Range.getBoundingClientRect()` 计算菜单的屏幕坐标，并将菜单定位到选区上方。
    - 在滚动或窗口尺寸变化时自动隐藏菜单，避免位置错位。

- **`composables/useAiExplainSelection.ts`**
  - 负责管理“AI 解释选中单词”的调用状态与结果：
    - 使用 `streamExplainSelection` 与豆包接口建立流式连接，将返回的增量内容拼接到 `output` 中。
    - 暴露 `isPanelVisible`、`isLoading`、`errorMessage`、`output`、`currentWord` 等状态供视图消费。
    - 当用户在浮动菜单中点击“解释”时，`Book.vue` 会调用 `explainSelection({ text, context })`，从而触发 AI 请求并打开右下角结果面板。

- **`composables/useVocabularyHighlight.ts`**
  - 负责在阅读区域中根据当前书籍的生词记录渲染高亮：
    - 从 Dexie 的 `vocabulary` 表按 `bookId` 读取对应书籍的所有生词项。
    - 在给定的根节点下遍历文本节点，按单词边界匹配 `VocabularyItem.word`，并用 `<span class="vocab-word">` 包裹匹配到的单词。
    - 在章节 HTML 或 `bookId` 变化时重新应用高亮，并在更新前清理已有的 `.vocab-word` 包装，避免重复嵌套。
    - 在生成高亮 `<span>` 时，通过 `data-vocab-id`、`data-vocab-word`、`data-vocab-context`、`data-vocab-explanation` 挂载生词元数据，供点击交互复用。
    - 当前已在 `ColumnReader`、`ScrollReader` 与 `ScrollWithNote` 三种阅读模式中接入：各自通过 `bookId` 与章节 HTML，将高亮逻辑限定在正文区域（`article`/`article-text`）内。

- **`composables/useVocabularyPopup.ts`**
  - 负责在阅读区域内处理对 `.vocab-word` 高亮元素的点击交互：
    - 在给定的根节点（通常为阅读器正文容器）上注册事件委托，捕获用户点击任意高亮生词的行为。
    - 从被点击元素的 `data-vocab-*` 属性中读取 `word`、`context`、`aiExplanation` 等信息，填充到响应式状态中。
    - 暴露 `visible`、`word`、`context`、`explanation` 以及 `position`（`'top' | 'bottom'`）等状态和 `close()` 方法：
      - 在桌面端根据被点击生词在视口中的垂直位置自动计算生词详情面板应靠近屏幕上半区还是下半区，尽量避免遮挡当前阅读区域；
      - 在移动端始终固定为底部抽屉样式，由 `VocabularyDetailPanel` 负责以贴底方式展示。

- **`components/AiExplainPanel.vue`**
  - 右下角的 AI 结果展示面板：
    - 通过 props 接收 `visible`、`loading`、`error`、`word`、`content` 等信息，由外层控制显隐和内容。
    - 在 `loading` 为真时展示“正在分析...”之类的提示文案；当 `error` 为特定标识（如 `no-api-key`）时，展示“请先在设置页中配置 AI 接口 Key”提示。
    - 提供 `close` 事件用于关闭面板但不清空历史内容，便于用户随时重新查看最近一次解释结果。

- **`components/SelectionMenu.vue`**
  - 纯 UI 浮动菜单组件：
    - 通过 props 接收 `visible`、`x`、`y`、`text` 等信息，并以固定定位方式渲染在屏幕上。
    - 提供“解释”“加入生词本”“关闭”等操作按钮，通过 `explain`、`add-vocabulary`、`close` 事件向上层视图汇报用户操作。
    - 当前阶段仅输出调试日志，后续将挂接到 AI 分析服务和生词本写入逻辑.
